#!/usr/bin/env bash

root=~/music

if [[ $# == 0 || "$1" == '--help' || "$1" == '-h' ]]; then
	echo 'Usage: musorg <file> ...' >&2
	[[ $# != 0 ]]; exit
fi

if [[ -z `which taffy 2>/dev/null` ]]; then
	echo 'musorg: taffy not installed' >&2
	exit 1
fi

gettag () {
	echo "$1" | grep "^$2:" | sed "s/^$2: \+\(.\+\)$/\1/" | shellname -s \
        | tr -d .
}

status=0

for arg; do
	tags=$(taffy "$arg" 2>/dev/null)
	if [[ $? != 0 ]]; then
		echo "$arg: unsupported file format"
		status=1
		continue
	fi
	album=$(gettag "$tags" album)
	title=$(gettag "$tags" title)
	track=$(printf %02d $(gettag "$tags" track))
	if [[ "$album" && "$track" ]]; then
		mkdir -p "$root/$album"
		ext=$(echo "$arg" | sed 's/.\+\(\..\+$\)/\1/')
		if [[ $(echo "$arg" | cut -d ' ' -f 1) == BotB ]]; then
			folder="$root/botb/$album"
		else
			folder="$root/$album"
		fi
		if [[ "$title" ]]; then
			mv -nv "$arg" "$folder/${track}-$title$ext" 2>/dev/null
		else
			mv -nv "$arg" "$folder/${track}$ext" 2>/dev/null
		fi
	else
		echo "$arg: not enough metadata" >&2
		status=1
	fi
done

exit $status
